<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amino Acid pH & Protonation Dynamics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .visualisation-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }
        
        .charts-panel {
            display: grid;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
        }
        
        .chart-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            position: relative;
            min-height: 250px;
        }
        
        canvas {
            display: block;
            margin: 0 auto;
            border-radius: 10px;
        }
        
        #solutionCanvas {
            background: linear-gradient(to bottom, #e3f2fd, #bbdefb);
            width: 100%;
            height: 500px;
        }
        
        .controls {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        input[type="range"] {
            flex: 1;
            height: 10px;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .ph-slider {
            background: linear-gradient(90deg, 
                #ff0000 0%, 
                #ff4500 7%, 
                #ffa500 14%, 
                #ffff00 35%, 
                #90ee90 50%, 
                #4169e1 65%, 
                #0000ff 86%, 
                #4b0082 100%);
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: white;
            border: 3px solid #667eea;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: white;
            border: 3px solid #667eea;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .value-display {
            background: white;
            padding: 5px 12px;
            border-radius: 8px;
            font-weight: 600;
            color: #667eea;
            min-width: 80px;
            text-align: center;
        }
        
        .speed-label {
            font-size: 12px;
            color: #666;
        }
        
        select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #667eea;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }
        
        .reset-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 20px;
            width: 100%;
        }
        
        .reset-button:hover {
            background: #5a67d8;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
        }
        
        .info-box h3 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 18px;
        }
        
        .info-box p {
            color: #555;
            line-height: 1.6;
            font-size: 15px;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            font-size: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-colour {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #333;
        }
        
        .chart-title {
            text-align: center;
            font-weight: 600;
            color: #555;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .proton-indicator {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            color: white;
            font-weight: 600;
            font-size: 16px;
            text-align: center;
        }
        
        .pka-markers {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .pka-marker {
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .pka-marker.active {
            background: #667eea;
            color: white;
            transform: scale(1.15);
            font-weight: bold;
        }
        
        .charge-display {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .positive-charge {
            color: #4CAF50;
            border: 2px solid #4CAF50;
        }
        
        .negative-charge {
            color: #f44336;
            border: 2px solid #f44336;
        }
        
        .neutral-charge {
            color: #9e9e9e;
            border: 2px solid #9e9e9e;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧬 Amino Acid pH & Protonation Dynamics</h1>
        
        <div class="controls">
            <div class="control-group">
                <label for="aminoAcidSelect">Select Amino Acid:</label>
                <select id="aminoAcidSelect">
                    <option value="glycine">Glycine (Gly) - Simple</option>
                    <option value="aspartic">Aspartic Acid (Asp) - Acidic</option>
                    <option value="glutamic">Glutamic Acid (Glu) - Acidic</option>
                    <option value="histidine">Histidine (His) - Basic/Aromatic</option>
                    <option value="cysteine">Cysteine (Cys) - Sulphur-containing</option>
                    <option value="tyrosine">Tyrosine (Tyr) - Aromatic</option>
                    <option value="lysine">Lysine (Lys) - Basic</option>
                    <option value="arginine">Arginine (Arg) - Basic</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="phSlider">Solution pH:</label>
                <div class="slider-container">
                    <span style="font-size: 12px; color: #666;">0</span>
                    <input type="range" id="phSlider" class="ph-slider" min="0" max="14" value="7" step="0.1">
                    <span style="font-size: 12px; color: #666;">14</span>
                    <div class="value-display" id="phValue">pH 7.0</div>
                </div>
            </div>
            
            <div class="control-group">
                <label for="speedSlider">Animation Speed:</label>
                <div class="slider-container">
                    <span class="speed-label">Slow</span>
                    <input type="range" id="speedSlider" min="0.5" max="3" value="1" step="0.5">
                    <span class="speed-label">Fast</span>
                    <div class="value-display" id="speedValue">1.0×</div>
                </div>
            </div>
            
            <button class="reset-button" id="resetButton">🔄 Reset Animation</button>
        </div>
        
        <div class="main-grid">
            <div class="visualisation-panel">
                <div class="chart-title">Amino Acid Structure in Solution</div>
                <div style="position: relative;">
                    <canvas id="solutionCanvas"></canvas>
                    <div id="chargeDisplay" class="charge-display neutral-charge">Net Charge: 0.00</div>
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-colour" style="background: #ff4444;"></div>
                        <span>H⁺ (Proton)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-colour" style="background: #4444ff;"></div>
                        <span>OH⁻ (Hydroxide)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-colour" style="background: #4CAF50;"></div>
                        <span>Protonated Group</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-colour" style="background: #f44336;"></div>
                        <span>Deprotonated Group</span>
                    </div>
                </div>
                <div class="pka-markers" id="pkaMarkers"></div>
            </div>
            
            <div class="charts-panel">
                <div class="chart-container">
                    <div class="chart-title">Charge vs pH (Titration Curve)</div>
                    <canvas id="titrationChart" width="500" height="250"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Buffering Capacity</div>
                    <canvas id="bufferChart" width="500" height="250"></canvas>
                </div>
            </div>
        </div>
        
        <div class="proton-indicator" id="protonIndicator">
            [H⁺] = 1.0 × 10⁻⁷ M | [OH⁻] = 1.0 × 10⁻⁷ M | Predominant Species
        </div>
        
        <div class="info-box">
            <h3>Current Parameters</h3>
            <p id="kineticsInfo">
                Loading...
            </p>
        </div>
    </div>

    <script>
        // Global variables
        let particles = [];
        let aminoAcidMolecule = null;
        let currentAminoAcid = 'glycine';
        let currentPH = 7.0;
        let animationSpeed = 1;
        let animationId;
        let time = 0;
        
        // Amino acid data
        const aminoAcids = {
            glycine: {
                name: 'Glycine',
                pKa_COOH: 2.34,
                pKa_NH3: 9.60,
                pKa_R: null,
                pI: 5.97,
                code: 'Gly',
                rGroup: 'H'
            },
            aspartic: {
                name: 'Aspartic Acid',
                pKa_COOH: 1.88,
                pKa_NH3: 9.60,
                pKa_R: 3.65,
                pI: 2.77,
                code: 'Asp',
                rGroup: 'CH2COOH'
            },
            glutamic: {
                name: 'Glutamic Acid',
                pKa_COOH: 2.19,
                pKa_NH3: 9.67,
                pKa_R: 4.25,
                pI: 3.22,
                code: 'Glu',
                rGroup: 'CH2CH2COOH'
            },
            histidine: {
                name: 'Histidine',
                pKa_COOH: 1.82,
                pKa_NH3: 9.17,
                pKa_R: 6.00,
                pI: 7.59,
                code: 'His',
                rGroup: 'Imidazole'
            },
            cysteine: {
                name: 'Cysteine',
                pKa_COOH: 1.96,
                pKa_NH3: 10.28,
                pKa_R: 8.18,
                pI: 5.07,
                code: 'Cys',
                rGroup: 'CH2SH'
            },
            tyrosine: {
                name: 'Tyrosine',
                pKa_COOH: 2.20,
                pKa_NH3: 9.11,
                pKa_R: 10.07,
                pI: 5.66,
                code: 'Tyr',
                rGroup: 'Phenol'
            },
            lysine: {
                name: 'Lysine',
                pKa_COOH: 2.18,
                pKa_NH3: 8.95,
                pKa_R: 10.53,
                pI: 9.74,
                code: 'Lys',
                rGroup: '(CH2)4NH2'
            },
            arginine: {
                name: 'Arginine',
                pKa_COOH: 2.17,
                pKa_NH3: 9.04,
                pKa_R: 12.48,
                pI: 10.76,
                code: 'Arg',
                rGroup: 'Guanidinium'
            }
        };
        
        // Canvas setup
        const solutionCanvas = document.getElementById('solutionCanvas');
        const solutionCtx = solutionCanvas.getContext('2d');
        const titrationCanvas = document.getElementById('titrationChart');
        const titrationCtx = titrationCanvas.getContext('2d');
        const bufferCanvas = document.getElementById('bufferChart');
        const bufferCtx = bufferCanvas.getContext('2d');
        
        // Resize canvases
        function resizeCanvases() {
            solutionCanvas.width = solutionCanvas.offsetWidth;
            solutionCanvas.height = 500;
            titrationCanvas.width = 500;
            titrationCanvas.height = 250;
            bufferCanvas.width = 500;
            bufferCanvas.height = 250;
        }
        
        // Particle class for H+, OH-, and H2O
        class Particle {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.type = type; // 'proton', 'hydroxide', or 'water'
                this.radius = type === 'water' ? 6 : 12;
            }
            
            update() {
                this.x += this.vx * animationSpeed;
                this.y += this.vy * animationSpeed;
                
                // Bounce off walls
                if (this.x - this.radius < 0 || this.x + this.radius > solutionCanvas.width) {
                    this.vx = -this.vx;
                }
                if (this.y - this.radius < 0 || this.y + this.radius > solutionCanvas.height) {
                    this.vy = -this.vy;
                }
                
                // Keep in bounds
                this.x = Math.max(this.radius, Math.min(solutionCanvas.width - this.radius, this.x));
                this.y = Math.max(this.radius, Math.min(solutionCanvas.height - this.radius, this.y));
                
                // Subtle interaction with amino acid - just slow down briefly when close
                if (aminoAcidMolecule && this.type !== 'water') {
                    const dx = this.x - aminoAcidMolecule.x;
                    const dy = this.y - aminoAcidMolecule.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    // Particles slow down near the amino acid molecule
                    if (distance < 150) {
                        const slowFactor = 0.98;
                        
                        if (this.type === 'proton' && currentPH < 7) {
                            // Protons attracted more at low pH
                            this.vx *= slowFactor;
                            this.vy *= slowFactor;
                        } else if (this.type === 'hydroxide' && currentPH > 7) {
                            // Hydroxides attracted more at high pH
                            this.vx *= slowFactor;
                            this.vy *= slowFactor;
                        }
                        
                        // Add slight repulsion to prevent particles getting stuck
                        if (distance < 100) {
                            const repelForce = 0.1;
                            this.vx += (dx / distance) * repelForce;
                            this.vy += (dy / distance) * repelForce;
                        }
                    }
                }
            }
            
            draw() {
                solutionCtx.beginPath();
                solutionCtx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                
                if (this.type === 'proton') {
                    solutionCtx.fillStyle = '#ff4444';
                    solutionCtx.fill();
                    solutionCtx.fillStyle = 'white';
                    solutionCtx.font = 'bold 16px Arial';
                    solutionCtx.textAlign = 'center';
                    solutionCtx.textBaseline = 'middle';
                    solutionCtx.fillText('H⁺', this.x, this.y);
                } else if (this.type === 'hydroxide') {
                    solutionCtx.fillStyle = '#4444ff';
                    solutionCtx.fill();
                    solutionCtx.fillStyle = 'white';
                    solutionCtx.font = 'bold 14px Arial';
                    solutionCtx.textAlign = 'center';
                    solutionCtx.textBaseline = 'middle';
                    solutionCtx.fillText('OH⁻', this.x, this.y);
                } else {
                    solutionCtx.fillStyle = 'rgba(144, 238, 144, 0.4)';
                    solutionCtx.fill();
                }
                
                solutionCtx.strokeStyle = '#333';
                solutionCtx.lineWidth = 1;
                solutionCtx.stroke();
            }
        }
        
        // Amino Acid Molecule class
        class AminoAcidMolecule {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.rotation = 0;
            }
            
            update() {
                // Gentle wobble
                this.rotation = Math.sin(time * 0.02) * 0.05;
            }
            
            draw() {
                const aa = aminoAcids[currentAminoAcid];
                
                // Determine protonation states
                const coohProtonated = currentPH < aa.pKa_COOH;
                const nh3Protonated = currentPH < aa.pKa_NH3;
                let rProtonated = null;
                
                if (aa.pKa_R !== null) {
                    if (currentAminoAcid === 'histidine' || currentAminoAcid === 'lysine' || currentAminoAcid === 'arginine') {
                        rProtonated = currentPH < aa.pKa_R;
                    } else {
                        rProtonated = currentPH < aa.pKa_R;
                    }
                }
                
                solutionCtx.save();
                solutionCtx.translate(this.x, this.y);
                solutionCtx.rotate(this.rotation);
                // Scale everything up by 2x
                solutionCtx.scale(2, 2);
                
                // Draw backbone
                solutionCtx.strokeStyle = '#333';
                solutionCtx.lineWidth = 2.5;
                
                // Central carbon
                solutionCtx.fillStyle = '#666';
                solutionCtx.beginPath();
                solutionCtx.arc(0, 0, 10, 0, Math.PI * 2);
                solutionCtx.fill();
                solutionCtx.fillStyle = 'white';
                solutionCtx.font = 'bold 16px Arial';
                solutionCtx.textAlign = 'center';
                solutionCtx.textBaseline = 'middle';
                solutionCtx.fillText('C', 0, 0);
                
                // Draw NH3+/NH2 group (left)
                solutionCtx.beginPath();
                solutionCtx.moveTo(-10, 0);
                solutionCtx.lineTo(-40, -20);
                solutionCtx.stroke();
                
                // Draw N-H bonds FIRST (so they appear behind the N atom)
                if (nh3Protonated) {
                    // NH3+ - three hydrogens above nitrogen
                    for (let i = 0; i < 3; i++) {
                        const angle = -Math.PI/2 + (i - 1) * Math.PI/4;
                        const hx = -40 + Math.cos(angle) * 25;
                        const hy = -20 + Math.sin(angle) * 25;
                        solutionCtx.strokeStyle = '#333';
                        solutionCtx.lineWidth = 1.5;
                        solutionCtx.beginPath();
                        solutionCtx.moveTo(-40, -20);
                        solutionCtx.lineTo(hx, hy);
                        solutionCtx.stroke();
                    }
                } else {
                    // NH2 - two hydrogens above nitrogen
                    for (let i = 0; i < 2; i++) {
                        const angle = -Math.PI/2 + (i - 0.5) * Math.PI/3;
                        const hx = -40 + Math.cos(angle) * 25;
                        const hy = -20 + Math.sin(angle) * 25;
                        solutionCtx.strokeStyle = '#333';
                        solutionCtx.lineWidth = 1.5;
                        solutionCtx.beginPath();
                        solutionCtx.moveTo(-40, -20);
                        solutionCtx.lineTo(hx, hy);
                        solutionCtx.stroke();
                    }
                }
                
                // NOW draw the nitrogen atom on TOP of the bonds
                solutionCtx.fillStyle = nh3Protonated ? '#4CAF50' : '#f44336';
                solutionCtx.beginPath();
                solutionCtx.arc(-40, -20, 12, 0, Math.PI * 2);
                solutionCtx.fill();
                solutionCtx.fillStyle = 'white';
                solutionCtx.font = 'bold 16px Arial';
                solutionCtx.fillText('N', -40, -20);
                
                // Draw hydrogens and charge
                if (nh3Protonated) {
                    // Draw the hydrogen atoms
                    for (let i = 0; i < 3; i++) {
                        const angle = -Math.PI/2 + (i - 1) * Math.PI/4;
                        const hx = -40 + Math.cos(angle) * 25;
                        const hy = -20 + Math.sin(angle) * 25;
                        solutionCtx.fillStyle = '#fff';
                        solutionCtx.beginPath();
                        solutionCtx.arc(hx, hy, 6, 0, Math.PI * 2);
                        solutionCtx.fill();
                        solutionCtx.fillStyle = '#333';
                        solutionCtx.font = 'bold 14px Arial';
                        solutionCtx.fillText('H', hx, hy);
                    }
                    // Show positive charge BELOW nitrogen
                    solutionCtx.fillStyle = '#4CAF50';
                    solutionCtx.font = 'bold 20px Arial';
                    solutionCtx.fillText('+', -40, 0);
                } else {
                    // Draw the hydrogen atoms
                    for (let i = 0; i < 2; i++) {
                        const angle = -Math.PI/2 + (i - 0.5) * Math.PI/3;
                        const hx = -40 + Math.cos(angle) * 25;
                        const hy = -20 + Math.sin(angle) * 25;
                        solutionCtx.fillStyle = '#fff';
                        solutionCtx.beginPath();
                        solutionCtx.arc(hx, hy, 6, 0, Math.PI * 2);
                        solutionCtx.fill();
                        solutionCtx.fillStyle = '#333';
                        solutionCtx.font = 'bold 14px Arial';
                        solutionCtx.fillText('H', hx, hy);
                    }
                }
                
                // Draw COOH/COO- group (right)
                solutionCtx.strokeStyle = '#333';
                solutionCtx.lineWidth = 2.5;
                solutionCtx.beginPath();
                solutionCtx.moveTo(10, 0);
                solutionCtx.lineTo(40, 0);
                solutionCtx.stroke();
                
                // Carboxyl carbon
                solutionCtx.fillStyle = '#666';
                solutionCtx.beginPath();
                solutionCtx.arc(40, 0, 10, 0, Math.PI * 2);
                solutionCtx.fill();
                solutionCtx.fillStyle = 'white';
                solutionCtx.font = 'bold 16px Arial';
                solutionCtx.fillText('C', 40, 0);
                
                // Double bond oxygen (always present)
                solutionCtx.strokeStyle = '#333';
                solutionCtx.lineWidth = 3.5;
                solutionCtx.beginPath();
                solutionCtx.moveTo(48, -6);
                solutionCtx.lineTo(65, -20);
                solutionCtx.stroke();
                solutionCtx.fillStyle = '#e53e3e';
                solutionCtx.beginPath();
                solutionCtx.arc(65, -20, 10, 0, Math.PI * 2);
                solutionCtx.fill();
                solutionCtx.fillStyle = 'white';
                solutionCtx.font = 'bold 16px Arial';
                solutionCtx.fillText('O', 65, -20);
                
                // Single bond oxygen
                solutionCtx.strokeStyle = '#333';
                solutionCtx.lineWidth = 2.5;
                solutionCtx.beginPath();
                solutionCtx.moveTo(48, 6);
                solutionCtx.lineTo(65, 20);
                solutionCtx.stroke();
                
                solutionCtx.fillStyle = coohProtonated ? '#4CAF50' : '#f44336';
                solutionCtx.beginPath();
                solutionCtx.arc(65, 20, 10, 0, Math.PI * 2);
                solutionCtx.fill();
                solutionCtx.fillStyle = 'white';
                solutionCtx.font = 'bold 16px Arial';
                solutionCtx.fillText('O', 65, 20);
                
                if (coohProtonated) {
                    // Draw H for COOH
                    solutionCtx.strokeStyle = '#333';
                    solutionCtx.lineWidth = 1.5;
                    solutionCtx.beginPath();
                    solutionCtx.moveTo(75, 20);
                    solutionCtx.lineTo(85, 20);
                    solutionCtx.stroke();
                    solutionCtx.fillStyle = '#fff';
                    solutionCtx.beginPath();
                    solutionCtx.arc(85, 20, 6, 0, Math.PI * 2);
                    solutionCtx.fill();
                    solutionCtx.fillStyle = '#333';
                    solutionCtx.font = 'bold 14px Arial';
                    solutionCtx.fillText('H', 85, 20);
                } else {
                    // Show negative charge for COO-
                    solutionCtx.fillStyle = '#f44336';
                    solutionCtx.font = 'bold 20px Arial';
                    solutionCtx.fillText('−', 65, 38);
                }
                
                // Draw H on central carbon
                solutionCtx.strokeStyle = '#333';
                solutionCtx.lineWidth = 1.5;
                solutionCtx.beginPath();
                solutionCtx.moveTo(0, -10);
                solutionCtx.lineTo(0, -25);
                solutionCtx.stroke();
                solutionCtx.fillStyle = '#fff';
                solutionCtx.beginPath();
                solutionCtx.arc(0, -25, 6, 0, Math.PI * 2);
                solutionCtx.fill();
                solutionCtx.fillStyle = '#333';
                solutionCtx.font = 'bold 14px Arial';
                solutionCtx.fillText('H', 0, -25);
                
                // Draw R group (bottom)
                solutionCtx.strokeStyle = '#333';
                solutionCtx.lineWidth = 2.5;
                solutionCtx.beginPath();
                solutionCtx.moveTo(0, 10);
                solutionCtx.lineTo(0, 35);
                solutionCtx.stroke();
                
                // Draw specific R groups
                if (currentAminoAcid === 'glycine') {
                    // Just H
                    solutionCtx.fillStyle = '#fff';
                    solutionCtx.beginPath();
                    solutionCtx.arc(0, 42, 6, 0, Math.PI * 2);
                    solutionCtx.fill();
                    solutionCtx.fillStyle = '#333';
                    solutionCtx.font = 'bold 14px Arial';
                    solutionCtx.fillText('H', 0, 42);
                } else if (currentAminoAcid === 'aspartic' || currentAminoAcid === 'glutamic') {
                    // Draw CH2 chain
                    const chainLength = currentAminoAcid === 'aspartic' ? 1 : 2;
                    for (let i = 0; i < chainLength; i++) {
                        const cy = 35 + i * 20;
                        solutionCtx.fillStyle = '#666';
                        solutionCtx.beginPath();
                        solutionCtx.arc(0, cy, 7, 0, Math.PI * 2);
                        solutionCtx.fill();
                        solutionCtx.fillStyle = 'white';
                        solutionCtx.font = 'bold 14px Arial';
                        solutionCtx.fillText('C', 0, cy);
                        
                        if (i < chainLength - 1) {
                            solutionCtx.strokeStyle = '#333';
                            solutionCtx.beginPath();
                            solutionCtx.moveTo(0, cy + 7);
                            solutionCtx.lineTo(0, cy + 13);
                            solutionCtx.stroke();
                        }
                    }
                    
                    // Draw COOH/COO- at end
                    const endY = 35 + chainLength * 20;
                    solutionCtx.strokeStyle = '#333';
                    solutionCtx.beginPath();
                    solutionCtx.moveTo(0, endY - 7);
                    solutionCtx.lineTo(0, endY + 8);
                    solutionCtx.stroke();
                    
                    // Carboxyl group
                    solutionCtx.fillStyle = rProtonated ? '#4CAF50' : '#f44336';
                    solutionCtx.beginPath();
                    solutionCtx.arc(0, endY + 15, 12, 0, Math.PI * 2);
                    solutionCtx.fill();
                    solutionCtx.fillStyle = 'white';
                    solutionCtx.font = 'bold 14px Arial';
                    solutionCtx.fillText(rProtonated ? 'COOH' : 'COO⁻', 0, endY + 15);
                } else if (currentAminoAcid === 'lysine') {
                    // Draw (CH2)4
                    for (let i = 0; i < 4; i++) {
                        const cy = 35 + i * 12;
                        solutionCtx.fillStyle = '#666';
                        solutionCtx.beginPath();
                        solutionCtx.arc(0, cy, 5, 0, Math.PI * 2);
                        solutionCtx.fill();
                        
                        if (i < 3) {
                            solutionCtx.strokeStyle = '#333';
                            solutionCtx.lineWidth = 1.5;
                            solutionCtx.beginPath();
                            solutionCtx.moveTo(0, cy + 5);
                            solutionCtx.lineTo(0, cy + 7);
                            solutionCtx.stroke();
                        }
                    }
                    
                    // Draw NH3+/NH2
                    solutionCtx.strokeStyle = '#333';
                    solutionCtx.lineWidth = 2.5;
                    solutionCtx.beginPath();
                    solutionCtx.moveTo(0, 80);
                    solutionCtx.lineTo(0, 90);
                    solutionCtx.stroke();
                    
                    solutionCtx.fillStyle = rProtonated ? '#4CAF50' : '#f44336';
                    solutionCtx.beginPath();
                    solutionCtx.arc(0, 98, 12, 0, Math.PI * 2);
                    solutionCtx.fill();
                    solutionCtx.fillStyle = 'white';
                    solutionCtx.font = 'bold 14px Arial';
                    solutionCtx.fillText(rProtonated ? 'NH₃⁺' : 'NH₂', 0, 98);
                } else if (currentAminoAcid === 'histidine') {
                    // Draw imidazole ring
                    solutionCtx.fillStyle = rProtonated ? '#4CAF50' : '#f44336';
                    solutionCtx.beginPath();
                    solutionCtx.arc(0, 55, 18, 0, Math.PI * 2);
                    solutionCtx.fill();
                    solutionCtx.fillStyle = 'white';
                    solutionCtx.font = 'bold 16px Arial';
                    solutionCtx.fillText(rProtonated ? 'ImH⁺' : 'Im', 0, 55);
                } else if (currentAminoAcid === 'cysteine') {
                    // Draw CH2
                    solutionCtx.fillStyle = '#666';
                    solutionCtx.beginPath();
                    solutionCtx.arc(0, 35, 7, 0, Math.PI * 2);
                    solutionCtx.fill();
                    solutionCtx.fillStyle = 'white';
                    solutionCtx.font = 'bold 14px Arial';
                    solutionCtx.fillText('C', 0, 35);
                    
                    // Draw SH/S-
                    solutionCtx.strokeStyle = '#333';
                    solutionCtx.beginPath();
                    solutionCtx.moveTo(0, 42);
                    solutionCtx.lineTo(0, 52);
                    solutionCtx.stroke();
                    
                    solutionCtx.fillStyle = rProtonated ? '#4CAF50' : '#f44336';
                    solutionCtx.beginPath();
                    solutionCtx.arc(0, 60, 12, 0, Math.PI * 2);
                    solutionCtx.fill();
                    solutionCtx.fillStyle = 'white';
                    solutionCtx.font = 'bold 16px Arial';
                    solutionCtx.fillText(rProtonated ? 'SH' : 'S⁻', 0, 60);
                } else if (currentAminoAcid === 'tyrosine') {
                    // Draw benzene ring
                    solutionCtx.strokeStyle = '#333';
                    solutionCtx.lineWidth = 2.5;
                    solutionCtx.beginPath();
                    for (let i = 0; i < 6; i++) {
                        const angle = (i * Math.PI / 3) - Math.PI / 2;
                        const x = Math.cos(angle) * 20;
                        const y = 55 + Math.sin(angle) * 20;
                        if (i === 0) {
                            solutionCtx.moveTo(x, y);
                        } else {
                            solutionCtx.lineTo(x, y);
                        }
                    }
                    solutionCtx.closePath();
                    solutionCtx.stroke();
                    
                    // Draw OH/O-
                    solutionCtx.beginPath();
                    solutionCtx.moveTo(0, 75);
                    solutionCtx.lineTo(0, 85);
                    solutionCtx.stroke();
                    
                    solutionCtx.fillStyle = rProtonated ? '#4CAF50' : '#f44336';
                    solutionCtx.beginPath();
                    solutionCtx.arc(0, 92, 10, 0, Math.PI * 2);
                    solutionCtx.fill();
                    solutionCtx.fillStyle = 'white';
                    solutionCtx.font = 'bold 14px Arial';
                    solutionCtx.fillText(rProtonated ? 'OH' : 'O⁻', 0, 92);
                } else if (currentAminoAcid === 'arginine') {
                    // Draw (CH2)3
                    for (let i = 0; i < 3; i++) {
                        const cy = 35 + i * 12;
                        solutionCtx.fillStyle = '#666';
                        solutionCtx.beginPath();
                        solutionCtx.arc(0, cy, 5, 0, Math.PI * 2);
                        solutionCtx.fill();
                        
                        if (i < 2) {
                            solutionCtx.strokeStyle = '#333';
                            solutionCtx.lineWidth = 1.5;
                            solutionCtx.beginPath();
                            solutionCtx.moveTo(0, cy + 5);
                            solutionCtx.lineTo(0, cy + 7);
                            solutionCtx.stroke();
                        }
                    }
                    
                    // Draw guanidinium group
                    solutionCtx.strokeStyle = '#333';
                    solutionCtx.lineWidth = 2.5;
                    solutionCtx.beginPath();
                    solutionCtx.moveTo(0, 58);
                    solutionCtx.lineTo(0, 70);
                    solutionCtx.stroke();
                    
                    solutionCtx.fillStyle = rProtonated ? '#4CAF50' : '#f44336';
                    solutionCtx.beginPath();
                    solutionCtx.arc(0, 80, 14, 0, Math.PI * 2);
                    solutionCtx.fill();
                    solutionCtx.fillStyle = 'white';
                    solutionCtx.font = 'bold 12px Arial';
                    solutionCtx.fillText(rProtonated ? 'C(NH₂)₂⁺' : 'C(NH₂)NH', 0, 80);
                }
                
                solutionCtx.restore();
            }
        }
        
        // Calculate charge at given pH
        function calculateCharge(pH, aminoAcid) {
            const aa = aminoAcids[aminoAcid];
            let charge = 0;
            
            // COOH group
            const coohCharge = -1 / (1 + Math.pow(10, aa.pKa_COOH - pH));
            charge += coohCharge;
            
            // NH3 group
            const nh3Charge = 1 / (1 + Math.pow(10, pH - aa.pKa_NH3));
            charge += nh3Charge;
            
            // R group (if ionisable)
            if (aa.pKa_R !== null) {
                if (aminoAcid === 'aspartic' || aminoAcid === 'glutamic' || 
                    aminoAcid === 'cysteine' || aminoAcid === 'tyrosine') {
                    // Groups that lose protons
                    const rCharge = -1 / (1 + Math.pow(10, aa.pKa_R - pH));
                    charge += rCharge;
                } else {
                    // Groups that gain protons
                    const rCharge = 1 / (1 + Math.pow(10, pH - aa.pKa_R));
                    charge += rCharge;
                }
            }
            
            return charge;
        }
        
        // Calculate buffer capacity
        function calculateBufferCapacity(pH, aminoAcid) {
            const aa = aminoAcids[aminoAcid];
            let capacity = 0;
            const ln10 = Math.log(10);
            
            // COOH contribution
            const coohTerm = Math.pow(10, aa.pKa_COOH - pH);
            capacity += coohTerm / Math.pow(1 + coohTerm, 2);
            
            // NH3 contribution
            const nh3Term = Math.pow(10, pH - aa.pKa_NH3);
            capacity += 1 / (Math.pow(1 + nh3Term, 2) * nh3Term);
            
            // R group contribution
            if (aa.pKa_R !== null) {
                if (aminoAcid === 'aspartic' || aminoAcid === 'glutamic' || 
                    aminoAcid === 'cysteine' || aminoAcid === 'tyrosine') {
                    const rTerm = Math.pow(10, aa.pKa_R - pH);
                    capacity += rTerm / Math.pow(1 + rTerm, 2);
                } else {
                    const rTerm = Math.pow(10, pH - aa.pKa_R);
                    capacity += 1 / (Math.pow(1 + rTerm, 2) * rTerm);
                }
            }
            
            return capacity * ln10;
        }
        
        // Initialize particles based on pH
        function initParticles() {
            particles = [];
            
            // Calculate particle numbers based on pH
            const numProtons = Math.max(0, Math.min(15, Math.round(15 * (1 - currentPH/14))));
            const numHydroxides = Math.max(0, Math.min(15, Math.round(15 * currentPH/14)));
            const numWater = 8; // Constant water molecules
            
            // Create protons
            for (let i = 0; i < numProtons; i++) {
                particles.push(new Particle(
                    Math.random() * solutionCanvas.width,
                    Math.random() * solutionCanvas.height,
                    'proton'
                ));
            }
            
            // Create hydroxides
            for (let i = 0; i < numHydroxides; i++) {
                particles.push(new Particle(
                    Math.random() * solutionCanvas.width,
                    Math.random() * solutionCanvas.height,
                    'hydroxide'
                ));
            }
            
            // Create water molecules
            for (let i = 0; i < numWater; i++) {
                particles.push(new Particle(
                    Math.random() * solutionCanvas.width,
                    Math.random() * solutionCanvas.height,
                    'water'
                ));
            }
            
            // Create amino acid molecule
            aminoAcidMolecule = new AminoAcidMolecule(
                solutionCanvas.width / 2,
                solutionCanvas.height / 2
            );
        }
        
        // Update charge display
        function updateChargeDisplay() {
            const charge = calculateCharge(currentPH, currentAminoAcid);
            const chargeDisplay = document.getElementById('chargeDisplay');
            const chargeText = `Net Charge: ${charge > 0 ? '+' : ''}${charge.toFixed(2)}`;
            
            chargeDisplay.textContent = chargeText;
            chargeDisplay.className = 'charge-display ' + 
                (charge > 0.1 ? 'positive-charge' : 
                 charge < -0.1 ? 'negative-charge' : 
                 'neutral-charge');
        }
        
        // Update pKa markers
        function updatePkaMarkers() {
            const aa = aminoAcids[currentAminoAcid];
            const markersDiv = document.getElementById('pkaMarkers');
            let html = '';
            
            // Add pKa markers
            const markers = [
                { name: 'α-COOH', value: aa.pKa_COOH },
                { name: 'α-NH₃⁺', value: aa.pKa_NH3 }
            ];
            
            if (aa.pKa_R !== null) {
                let rName = 'R-group';
                if (currentAminoAcid === 'aspartic' || currentAminoAcid === 'glutamic') {
                    rName = 'β/γ-COOH';
                } else if (currentAminoAcid === 'histidine') {
                    rName = 'Imidazole';
                } else if (currentAminoAcid === 'cysteine') {
                    rName = 'Thiol';
                } else if (currentAminoAcid === 'tyrosine') {
                    rName = 'Phenol';
                } else if (currentAminoAcid === 'lysine') {
                    rName = 'ε-NH₃⁺';
                } else if (currentAminoAcid === 'arginine') {
                    rName = 'Guanidinium';
                }
                markers.push({ name: rName, value: aa.pKa_R });
            }
            
            markers.push({ name: 'pI', value: aa.pI });
            
            markers.forEach(marker => {
                const isActive = Math.abs(currentPH - marker.value) < 1;
                html += `<div class="pka-marker ${isActive ? 'active' : ''}">
                            ${marker.name}: ${marker.value.toFixed(2)}
                         </div>`;
            });
            
            markersDiv.innerHTML = html;
        }
        
        // Draw titration curve
        function drawTitrationCurve() {
            const width = titrationCanvas.width;
            const height = titrationCanvas.height;
            titrationCtx.clearRect(0, 0, width, height);
            
            // Draw axes
            titrationCtx.strokeStyle = '#666';
            titrationCtx.lineWidth = 2;
            titrationCtx.beginPath();
            titrationCtx.moveTo(50, 20);
            titrationCtx.lineTo(50, height - 40);
            titrationCtx.lineTo(width - 20, height - 40);
            titrationCtx.stroke();
            
            // Labels
            titrationCtx.fillStyle = '#666';
            titrationCtx.font = 'bold 14px Arial';
            titrationCtx.textAlign = 'center';
            titrationCtx.fillText('pH', width/2, height - 10);
            
            titrationCtx.save();
            titrationCtx.translate(20, height/2);
            titrationCtx.rotate(-Math.PI/2);
            titrationCtx.fillText('Net Charge', 0, 0);
            titrationCtx.restore();
            
            // Grid
            titrationCtx.strokeStyle = '#e0e0e0';
            titrationCtx.lineWidth = 0.5;
            
            for (let pH = 0; pH <= 14; pH += 2) {
                const x = 50 + (pH * (width - 70) / 14);
                titrationCtx.beginPath();
                titrationCtx.moveTo(x, 20);
                titrationCtx.lineTo(x, height - 40);
                titrationCtx.stroke();
                
                titrationCtx.fillStyle = '#666';
                titrationCtx.font = 'bold 12px Arial';
                titrationCtx.textAlign = 'center';
                titrationCtx.fillText(pH.toString(), x, height - 25);
            }
            
            // Find charge range
            let maxCharge = -3, minCharge = 3;
            for (let pH = 0; pH <= 14; pH += 0.1) {
                const charge = calculateCharge(pH, currentAminoAcid);
                maxCharge = Math.max(maxCharge, charge);
                minCharge = Math.min(minCharge, charge);
            }
            const chargeRange = maxCharge - minCharge;
            
            // Draw charge grid
            for (let i = -2; i <= 2; i++) {
                const y = height - 40 - ((i - minCharge) * (height - 60) / chargeRange);
                titrationCtx.beginPath();
                titrationCtx.moveTo(50, y);
                titrationCtx.lineTo(width - 20, y);
                titrationCtx.stroke();
                
                titrationCtx.fillStyle = '#666';
                titrationCtx.font = 'bold 12px Arial';
                titrationCtx.textAlign = 'right';
                titrationCtx.fillText(i.toString(), 45, y + 3);
            }
            
            // Draw curve
            titrationCtx.strokeStyle = '#667eea';
            titrationCtx.lineWidth = 3;
            titrationCtx.beginPath();
            
            for (let pH = 0; pH <= 14; pH += 0.1) {
                const charge = calculateCharge(pH, currentAminoAcid);
                const x = 50 + (pH * (width - 70) / 14);
                const y = height - 40 - ((charge - minCharge) * (height - 60) / chargeRange);
                
                if (pH === 0) {
                    titrationCtx.moveTo(x, y);
                } else {
                    titrationCtx.lineTo(x, y);
                }
            }
            titrationCtx.stroke();
            
            // Draw pI line
            const aa = aminoAcids[currentAminoAcid];
            const pIx = 50 + (aa.pI * (width - 70) / 14);
            titrationCtx.strokeStyle = 'rgba(76, 175, 80, 0.5)';
            titrationCtx.lineWidth = 2;
            titrationCtx.setLineDash([5, 5]);
            titrationCtx.beginPath();
            titrationCtx.moveTo(pIx, 20);
            titrationCtx.lineTo(pIx, height - 40);
            titrationCtx.stroke();
            titrationCtx.setLineDash([]);
            
            // Draw current pH point
            const currentCharge = calculateCharge(currentPH, currentAminoAcid);
            const currentX = 50 + (currentPH * (width - 70) / 14);
            const currentY = height - 40 - ((currentCharge - minCharge) * (height - 60) / chargeRange);
            
            titrationCtx.fillStyle = '#FF5722';
            titrationCtx.beginPath();
            titrationCtx.arc(currentX, currentY, 8, 0, Math.PI * 2);
            titrationCtx.fill();
            titrationCtx.strokeStyle = '#333';
            titrationCtx.lineWidth = 2;
            titrationCtx.stroke();
        }
        
        // Draw buffer curve
        function drawBufferCurve() {
            const width = bufferCanvas.width;
            const height = bufferCanvas.height;
            bufferCtx.clearRect(0, 0, width, height);
            
            // Draw axes
            bufferCtx.strokeStyle = '#666';
            bufferCtx.lineWidth = 2;
            bufferCtx.beginPath();
            bufferCtx.moveTo(50, 20);
            bufferCtx.lineTo(50, height - 40);
            bufferCtx.lineTo(width - 20, height - 40);
            bufferCtx.stroke();
            
            // Labels
            bufferCtx.fillStyle = '#666';
            bufferCtx.font = 'bold 14px Arial';
            bufferCtx.textAlign = 'center';
            bufferCtx.fillText('pH', width/2, height - 10);
            
            bufferCtx.save();
            bufferCtx.translate(20, height/2);
            bufferCtx.rotate(-Math.PI/2);
            bufferCtx.fillText('Buffer Capacity', 0, 0);
            bufferCtx.restore();
            
            // Grid
            bufferCtx.strokeStyle = '#e0e0e0';
            bufferCtx.lineWidth = 0.5;
            
            for (let pH = 0; pH <= 14; pH += 2) {
                const x = 50 + (pH * (width - 70) / 14);
                bufferCtx.beginPath();
                bufferCtx.moveTo(x, 20);
                bufferCtx.lineTo(x, height - 40);
                bufferCtx.stroke();
                
                bufferCtx.fillStyle = '#666';
                bufferCtx.font = 'bold 12px Arial';
                bufferCtx.textAlign = 'center';
                bufferCtx.fillText(pH.toString(), x, height - 25);
            }
            
            // Find max capacity
            let maxCapacity = 0;
            for (let pH = 0; pH <= 14; pH += 0.1) {
                const capacity = calculateBufferCapacity(pH, currentAminoAcid);
                maxCapacity = Math.max(maxCapacity, capacity);
            }
            
            // Draw curve
            bufferCtx.strokeStyle = '#667eea';
            bufferCtx.lineWidth = 3;
            bufferCtx.beginPath();
            
            for (let pH = 0; pH <= 14; pH += 0.1) {
                const capacity = calculateBufferCapacity(pH, currentAminoAcid);
                const x = 50 + (pH * (width - 70) / 14);
                const y = height - 40 - (capacity * (height - 60) / maxCapacity);
                
                if (pH === 0) {
                    bufferCtx.moveTo(x, y);
                } else {
                    bufferCtx.lineTo(x, y);
                }
            }
            bufferCtx.stroke();
            
            // Mark pKa values
            const aa = aminoAcids[currentAminoAcid];
            const pKaValues = [aa.pKa_COOH, aa.pKa_NH3];
            if (aa.pKa_R !== null) pKaValues.push(aa.pKa_R);
            
            bufferCtx.fillStyle = 'rgba(255, 152, 0, 0.8)';
            pKaValues.forEach(pKa => {
                const x = 50 + (pKa * (width - 70) / 14);
                const capacity = calculateBufferCapacity(pKa, currentAminoAcid);
                const y = height - 40 - (capacity * (height - 60) / maxCapacity);
                
                bufferCtx.beginPath();
                bufferCtx.arc(x, y, 6, 0, Math.PI * 2);
                bufferCtx.fill();
            });
            
            // Current pH line
            const currentX = 50 + (currentPH * (width - 70) / 14);
            bufferCtx.strokeStyle = '#FF5722';
            bufferCtx.lineWidth = 2;
            bufferCtx.beginPath();
            bufferCtx.moveTo(currentX, 20);
            bufferCtx.lineTo(currentX, height - 40);
            bufferCtx.stroke();
        }
        
        // Update proton indicator
        function updateProtonIndicator() {
            const protonConc = Math.pow(10, -currentPH);
            const hydroxideConc = Math.pow(10, -(14 - currentPH));
            const aa = aminoAcids[currentAminoAcid];
            
            // Determine predominant species
            let species = '';
            const coohProtonated = currentPH < aa.pKa_COOH;
            const nh3Protonated = currentPH < aa.pKa_NH3;
            
            if (currentPH < 2) {
                species = 'Fully Protonated';
            } else if (currentPH > 12) {
                species = 'Fully Deprotonated';
            } else if (Math.abs(currentPH - aa.pI) < 0.5) {
                species = 'Zwitterion (Net Neutral)';
            } else if (currentPH < aa.pI) {
                species = 'Net Positive';
            } else {
                species = 'Net Negative';
            }
            
            document.getElementById('protonIndicator').innerHTML = `
                [H⁺] = ${protonConc.toExponential(1)} M | 
                [OH⁻] = ${hydroxideConc.toExponential(1)} M | 
                ${species}
            `;
        }
        
        // Update info box
        function updateInfo() {
            const aa = aminoAcids[currentAminoAcid];
            const charge = calculateCharge(currentPH, currentAminoAcid);
            const capacity = calculateBufferCapacity(currentPH, currentAminoAcid);
            
            let bufferStrength = 'Weak';
            if (capacity > 1.5) bufferStrength = 'Strong';
            else if (capacity > 0.5) bufferStrength = 'Moderate';
            
            document.getElementById('kineticsInfo').innerHTML = `
                <strong>${aa.name} (${aa.code})</strong> at pH ${currentPH.toFixed(1)}<br>
                <strong>Isoelectric Point (pI):</strong> ${aa.pI.toFixed(2)}<br>
                <strong>Net Charge:</strong> ${charge > 0 ? '+' : ''}${charge.toFixed(2)}<br>
                <strong>Buffer Capacity:</strong> ${capacity.toFixed(3)} (${bufferStrength})<br>
                <strong>pKa values:</strong> α-COOH = ${aa.pKa_COOH}, α-NH₃⁺ = ${aa.pKa_NH3}${aa.pKa_R ? `, R = ${aa.pKa_R}` : ''}
            `;
        }
        
        // Animation loop
        function animate() {
            solutionCtx.clearRect(0, 0, solutionCanvas.width, solutionCanvas.height);
            
            // Update and draw particles
            particles.forEach(particle => {
                particle.update();
                particle.draw();
            });
            
            // Update and draw amino acid
            if (aminoAcidMolecule) {
                aminoAcidMolecule.update();
                aminoAcidMolecule.draw();
            }
            
            time++;
            animationId = requestAnimationFrame(animate);
        }
        
        // Reset animation
        function resetAnimation() {
            time = 0;
            initParticles();
            updateChargeDisplay();
            updatePkaMarkers();
            drawTitrationCurve();
            drawBufferCurve();
            updateProtonIndicator();
            updateInfo();
        }
        
        // Event listeners
        document.getElementById('phSlider').addEventListener('input', function(e) {
            currentPH = parseFloat(e.target.value);
            document.getElementById('phValue').textContent = `pH ${currentPH.toFixed(1)}`;
            initParticles();
            updateChargeDisplay();
            updatePkaMarkers();
            drawTitrationCurve();
            drawBufferCurve();
            updateProtonIndicator();
            updateInfo();
        });
        
        document.getElementById('speedSlider').addEventListener('input', function(e) {
            animationSpeed = parseFloat(e.target.value);
            document.getElementById('speedValue').textContent = animationSpeed.toFixed(1) + '×';
        });
        
        document.getElementById('aminoAcidSelect').addEventListener('change', function(e) {
            currentAminoAcid = e.target.value;
            resetAnimation();
        });
        
        document.getElementById('resetButton').addEventListener('click', function() {
            resetAnimation();
        });
        
        // Initialize
        resizeCanvases();
        resetAnimation();
        animate();
        
        // Handle window resize
        window.addEventListener('resize', () => {
            resizeCanvases();
            resetAnimation();
        });
    </script>
</body>
</html>